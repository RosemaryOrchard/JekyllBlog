name: Automated Deployment to Server

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  personal-server:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Airtable Recommendations
        uses: JamesIves/fetch-api-data-action@v2.2.3
        with:
          endpoint: ${{ secrets.AIRTABLE_RECOMMENDATIONS }}
          configuration: '{ "method": "GET", "headers": {"Authorization": "Bearer ${{ secrets.AIRTABLE_TOKEN }}"} }'
          save-name: recommendations.json
          # save-location: _data
      # - name: Save Airtable Recommendations
      #   uses: test-room-7/action-update-file@v1
      #   with:
      #     file-path: _data/recommendations.json
      #     commit-msg: Updated Recommmendations
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Save Recommendations
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: main # Pushes the updates to the main branch.
          folder: fetch-api-data-action # The location of the data.json file saved by the Fetch API Data action.
          target-folder: _data # Saves the data into the 'data' directory on the main branch.
          token: ${{ secrets.DEPLOY_TOKEN }}
      - name: Deploy on Server
        uses: appleboy/ssh-action@dce9d565de8d876c11d93fa4fe677c0285a66d78
        env:
          JEKYLL_ENV: "production"
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          envs: JEKYLL_ENV
          script: |
            cd ~/JekyllBlog;
            git stash;
            git pull -r;
            $(which bundle) install;
            bundle exec jekyll build --config _config.yml,_config_prod.yml,_config_local.yml --quiet && echo 0;
      - name: Telegram Action
        uses: xinthink/action-telegram@v1.1
        with:
          botToken: ${{ secrets.BotToken }}
          chatId: ${{ secrets.ChatID }}
          jobStatus: ${{ job.status }}
          skipSuccess: false